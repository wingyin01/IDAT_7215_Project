{% extends "base.html" %}

{% block title %}Case Search - HK Criminal Law Expert System{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, #667eea22 0%, #764ba233 100%); border-left: 5px solid #667eea; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
    <h3 style="color: #667eea; margin-top: 0; margin-bottom: 0.8rem;">‚öñÔ∏è Real Hong Kong Criminal Appeal Cases</h3>
    <p style="margin-bottom: 0.8rem;">
        <strong>Database Contains:</strong> 29 real cases from the <strong>Court of Appeal</strong> (Criminal Appeals, 2018-2025)
    </p>
    <p style="margin-bottom: 0.8rem; font-size: 0.95rem;">
        <strong>‚ö†Ô∏è Scope:</strong> This database focuses on <strong>criminal law appeals</strong> only. 
        For civil, employment, property, or other legal areas, please consult comprehensive legal databases.
    </p>
    <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">
        <strong>Copyright Notice:</strong> Cases sourced from official <a href="https://legalref.judiciary.hk/" target="_blank" style="color: #667eea;">HK Judiciary Database</a>. 
        Used for educational/research purposes under fair use. For official case research, visit the 
        <a href="https://legalref.judiciary.hk/" target="_blank" style="color: #667eea;">HK Judiciary website</a>.
    </p>
</div>

<div class="card">
    <h2>üîç Case Search</h2>
    <p>Search for similar criminal appeal cases from Hong Kong courts based on your scenario.</p>
</div>

<div class="card">
    <form id="search-form">
        <div class="form-group">
            <label for="search-query">Describe your scenario:</label>
            <textarea id="search-query" class="form-control" placeholder="For example: Person threatened victim with knife and stole wallet..." required>Defendant trafficked 2.5 kilograms of cocaine concealed in luggage arriving from Colombia. Customs officers discovered the drugs during routine inspection at Hong Kong International Airport. The defendant claimed ignorance but evidence showed prior knowledge and intent to distribute.</textarea>
        </div>
        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
            üí° <strong>Tip:</strong> Serious criminal case example provided. Replace with your own scenario to search.
        </p>
        
        <div class="form-group">
            <label for="top-n">Number of cases to find:</label>
            <select id="top-n" class="form-control">
                <option value="1">1 case</option>
                <option value="2" selected>2 cases</option>
                <option value="3">3 cases</option>
                <option value="4">4 cases</option>
                <option value="5">5 cases</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">Search Cases</button>
    </form>
</div>

<div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Searching cases...</p>
</div>

<div id="results" style="display: none;">
    <div class="card">
        <h2>üìö Similar Cases Found</h2>
        <div id="results-content"></div>
    </div>
</div>

<script>
document.getElementById('search-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const query = document.getElementById('search-query').value;
    const topN = document.getElementById('top-n').value;
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');
    
    loader.classList.add('active');
    results.style.display = 'none';
    
    try {
        const response = await fetch('/api/search-cases', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({query: query, top_n: parseInt(topN)})
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        let html = '';
        
        if (data.results.length === 0) {
            html = '<p>No similar cases found. Try rephrasing your query.</p>';
        } else {
            html = `<p>Found ${data.total} similar case(s):</p>`;
            
            data.results.forEach((caseData, idx) => {
                // Fix case name display - use case_id if name is missing or contains "BETWEEN"
                let displayName = caseData.case_name;
                if (!displayName || displayName.trim() === '' || displayName.includes('BETWEEN') || displayName.includes('Before:')) {
                    displayName = `Criminal Appeal Case (${caseData.year})`;
                }
                if (displayName.length > 100) {
                    displayName = displayName.substring(0, 100) + '...';
                }
                
                html += `
                    <div class="case-item">
                        <h3>${idx + 1}. ${displayName}</h3>
                        <p><strong>Year:</strong> ${caseData.year} | <strong>Similarity:</strong> <span style="color: #667eea; font-weight: bold;">${caseData.similarity}</span></p>
                        <p><strong>Court:</strong> ${caseData.court}</p>
                        <p><strong>Outcome:</strong> ${caseData.outcome}</p>
                        <p><strong>Sentence:</strong> ${caseData.sentence || 'Not specified'}</p>
                        
                        <div style="margin-top: 1rem;">
                            <strong>Facts:</strong>
                            <p style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                                ${caseData.facts}
                            </p>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <strong>Charges:</strong>
                            <p style="margin-top: 0.5rem; color: #555;">${caseData.charges || 'Not specified'}</p>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <strong>Legal Principles:</strong>
                            <ul style="margin-top: 0.5rem;">
                                ${Array.isArray(caseData.legal_principles) ? 
                                  caseData.legal_principles.map(principle => `<li>${principle}</li>`).join('') : 
                                  `<li>${caseData.legal_principles}</li>`}
                            </ul>
                        </div>
                    </div>
                `;
            });
        }
        
        document.getElementById('results-content').innerHTML = html;
        results.style.display = 'block';
        results.scrollIntoView({behavior: 'smooth'});
        
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        loader.classList.remove('active');
    }
});
</script>
{% endblock %}

